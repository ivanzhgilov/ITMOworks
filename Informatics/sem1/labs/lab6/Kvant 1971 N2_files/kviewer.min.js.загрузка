function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var _ref,_kbmsys;function ownKeys(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,a)}return o}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(o),!0).forEach(function(t){_defineProperty(e,t,o[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ownKeys(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))})}return e}function _defineProperty(e,t,o){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(e,t){if("object"!==_typeof(e)||null===e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var a=o.call(e,t||"default");if("object"!==_typeof(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _createForOfIteratorHelper(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var a=0,i=function(){};return{s:i,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,n=!0,s=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return n=e.done,e},e:function(e){s=!0,r=e},f:function(){try{n||null==o.return||o.return()}finally{if(s)throw r}}}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,a=new Array(t);o<t;o++)a[o]=e[o];return a}function _iterableToArrayLimit(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var a,i,r,n,s=[],l=!0,c=!1;try{if(r=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;l=!1}else for(;!(l=(a=r.call(o)).done)&&(s.push(a.value),s.length!==t);l=!0);}catch(e){c=!0,i=e}finally{try{if(!l&&null!=o.return&&(n=o.return(),Object(n)!==n))return}finally{if(c)throw i}}return s}}function _arrayWithHoles(e){if(Array.isArray(e))return e}jQuery.fn.delayHide=function(){var e=$(this);return clearTimeout(e.data("hideTimeout")),e.data("hideTimeout",setTimeout(function(){e.css({display:"none"})},200)),e},jQuery.fn.delayShow=function(){var e=$(this);return clearTimeout(e.data("hideTimeout")),e.css({display:"",visibility:""}),e},jQuery.fn.blink=function(){var e=$(this);return e.finish().addClass("blink").delay(600).queue(function(){$(this).removeClass("blink"),$(this).dequeue()}),e},jQuery.fn.scrollIntoViewIfNeeded=function(e){if(!this||!$(this)[0])return null;this[0].scrollIntoViewIfNeeded(e)},Element.prototype.scrollIntoViewIfNeeded=function(e){"use strict";function t(e,t){return{start:e,length:t,end:e+t}}function o(t,o){return!1===e||o.start<t.end&&t.start<o.end?Math.max(t.end-o.length,Math.min(o.start,t.start)):(t.start+t.end-o.length)/2}function a(e,t){return{x:e,y:t,translate:function(o,i){return a(e+o,t+i)}}}function i(e,t){for(;e;)t=t.translate(e.offsetLeft,e.offsetTop),e=e.offsetParent;return t}for(var r,n=i(this,a(0,0)),s=a(this.offsetWidth,this.offsetHeight),l=this.parentNode;l instanceof HTMLElement;)r=i(l,a(l.clientLeft,l.clientTop)),l.scrollLeft=o(t(n.x-r.x,s.x),t(l.scrollLeft,l.clientWidth)),l.scrollTop=o(t(n.y-r.y,s.y),t(l.scrollTop,l.clientHeight)),n=n.translate(-l.scrollLeft,-l.scrollTop),l=l.parentNode},Element.prototype.scrollHLIntoView=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,i=$(this),r=t||this.parentNode,n=r.getBoundingClientRect(),s=this.getBoundingClientRect(),l=function(e){var t=0,o=0;for(;e&&!isNaN(e.offsetLeft)&&!isNaN(e.offsetTop);)t+=e.offsetLeft-e.scrollLeft,o+=e.offsetTop-e.scrollTop,e=e.offsetParent;return{top:o,left:t}}(this),c=r.scrollTop,d=l.top-r.clientHeight/2+this.clientHeight/2,u=Math.abs((c-d)/r.offsetHeight);(e||s.top<n.top+30||s.bottom>n.bottom-30)&&(o?$(r).animate({scrollTop:d},{duration:Math.min((300+40*Math.floor(u))*a,2500),easing:"easeInOutCubic",complete:function(){i.blink()}}):r.scrollTop=d)},jQuery.extend(jQuery.easing,{easeInCubic:function(e,t,o,a,i){return a*(t/=i)*t*t+o},easeOutCubic:function(e,t,o,a,i){return a*((t=t/i-1)*t*t+1)+o},easeInOutCubic:function(e,t,o,a,i){return(t/=i/2)<1?a/2*t*t*t+o:a/2*((t-=2)*t*t+2)+o}});var maxZoom={"1x1":280,"2x1":220},minZoom={"1x1":30,"2x1":40},stepZoom=10,maxHTMLWidth=100,minHTMLWidth=40,stepHTMLWidth=10,throttleViewportChange=5,throttleDetectScroll=10,throttleDetectCurrent=10,throttleSyncTree=4,throttleSyncControls=2,throttleResize=10,throttleBookmarksLoad=null!==(_ref=(null===(_kbmsys=kbmsys)||void 0===_kbmsys?void 0:_kbmsys.poll)/3)&&void 0!==_ref?_ref:1e4,htmlChunckSize=20,gfxChunckSize=20,__serverResize=!1,kViewer=function e(t,o){var a=t.get(0);if(!o.url)return!1;a.kViewer=this,this.approot=t.parent(".app--root"),this.bookroot=t.parent(".viewer--root"),this.bookbox=t,o=jQuery.extend(!0,{},o,this.uacLoadSettings(),this.authLoadSettings(o.user)),jQuery.extend(this,{settings:o,$elviewer:t,$elheader:$("header"),eventNS:".kViewer"+ ++e.count}),t.attr("data-viewer","1"),window.activeBook=window.activeBook?window.activeBook:this,this.launchViewer()};jQuery.extend(kViewer.prototype,{launchViewer:function(){var e,t=this,o=decodeURIComponent(window.location.hash.slice(1));if(t.ctrlInit(),t.ldrInit(),t.setupCallbacks(),t.vpInitState(),t.trbInitState(o),t.setupNotifier(),t.hlInitState(),e=t.viewPortState,t[t.treeBoxState.visible&&!e.isMobile?"trbToggleVisibility":"_nop"](t,!0),t.settings.layoutModePrefer=e.isMobile?"1x1":t.settings.layoutModePrefer,t.vpSetLayoutMode(t.settings.layoutModePrefer,!0),t.vpSetViewMode(t.settings.viewModePrefer),e.isMobile||"kcms"===o)t.vpGfxZoom("*",!1,!0),t.vpHtmlTextSize("*",!0);else{var a=t.settings.zoom.gfx[e.layoutMode];t[a._h?"vpGfxZoom":"_nop"]("/",!1,!0),t[!a._h&&parseInt(a.level)?"vpGfxZoom":"_nop"](parseInt(a.level),!1,!0);var i=t.settings.zoom.html;t[i&&100!==i.level?"vpHtmlWidthDoc":"_nop"](parseInt(i.level),!1,!0)}"gfx"===e.viewMode?t.vpResize(!1,!1,{src:"laucher",action:"launchViewer",param:"gfx"}):"html"===t.viewPortState.viewMode&&(t.timerPreloadHTML=setInterval(function(){t.htmlLaunch&&(clearInterval(t.timerPreloadHTML),t.timerPreloadHTML=null,setTimeout(function(){t.vpResize(!1,!1,{src:"laucher",action:"launchViewer",param:"html"})},throttleViewportChange))},throttleViewportChange)),setTimeout(function(){t.bmbInitState(),t.initCopierState()},throttleViewportChange)},setAppState:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"active",t=this,o=t.viewPortState,a=t.highlighterState,i=t["viewport-gfx-container"][0],r=t["viewport-html-container"][0],n={active:"is-active",loading:"is-loading",loadingVP:"is-loading-viewport",loadingHL:"is-loading-hlboxes"};switch(e){case"active":t.isActive=!0,a.fetching=!1,o.html.fetching=!1,i.deflectScrollEvent=!1,r.deflectScrollEvent=!1,setTimeout(function(e){requestAnimationFrame(function(e){t.$elviewer.removeClass(Object.values(n).join(" ")).addClass(n.active)})},throttleResize);break;case"fetching-hlboxes":t.isActive=!1,a.fetching=!1,i.deflectScrollEvent=!0,r.deflectScrollEvent=!0,t.$elviewer.addClass(n.loadingHL).removeClass(n.active);break;case"loading-viewport":t.isActive=!1,o.html.fetching=!0,i.deflectScrollEvent=!0,r.deflectScrollEvent=!0,t.$elviewer.addClass(n.loadingVP).removeClass(n.active);break;case"inactive":default:t.isActive=!1,i.deflectScrollEvent=!0,r.deflectScrollEvent=!0,t.$elviewer.addClass(n.loading).removeClass(n.active)}},setupCallbacks:function(){var e,t,o={initialize:"onInitialize",load:"onLoad",focus:"onFocus",blur:"onBlur"};for(e in o)o.hasOwnProperty(e)&&(t=this.settings[o[e]])&&this.on(e,t)}}),jQuery.extend(kViewer.prototype,{}),jQuery.extend(kViewer.prototype,{urlManager:function(e){var t=this,o=[];this.isActive&&(clearTimeout(t.stateTimeout),t.stateTimeout=setTimeout(function(){var e,a,i,r=$('[data-viewer="1"]')[0],n=null==r||null===(e=r.kViewer)||void 0===e?void 0:e.settings,s=null==n||null===(a=n.urlTracking)||void 0===a?void 0:a.package,l=null==n||null===(i=n.urlTracking)||void 0===i?void 0:i.page;if(r.kViewer&&n&&l&&r.kViewer.gotoDone){var c=function(e){return/^-?\d+$/.test(e)},d=r.kViewer.pageIDX,u=r.kViewer.pageIDY,h=$(t["ctrl-nav-page"][d]),p=$(t["ctrl-nav-page"][u]),v=null==h?void 0:h.data("anchor"),f=(null==p||p.data("anchor"),c(null==h?void 0:h.text())?h.text():null),g=(c(p.text())&&p.text(),r.kViewer.highlighterState.cleanquery||":QUERY"),m=l.replace(":URL",s).replace(":PAGE",null!=f?f:v.trimChars(" $")).replace(":QUERY",g).replace("?hl=:QUERY","");o.push(d),o.push(u),$(window).trigger("datastate:set",["viewer:page",{idobject:s,pagex:Math.max(d,0),pagey:Math.max(u,0)}]),window.history.replaceState(o.join("-"),"",m)}},throttleViewportChange))}}),jQuery.fn.kViewerRun=function(e){var t=jQuery.fn.kViewerRun.defaults,o=jQuery.extend({},t,e);return this.each(function(){var e,t,a=$(this),i=$("[data-settings]").attr("data-settings");if(i=JSON.parse(i),this.kViewer)return!1;try{if(!(t=i).url)return!1}catch(e){return!1}e={url:t.url,viewModes:{gfx:!!t.modegfx,html:!!t.modehtml},textFeatures:{searchable:!!t.searchable,copyable:!!t.copyable},viewModePrefer:t.modeprefer?t.modeprefer:t.modegfx?"gfx":"html",layoutModes:{},layoutModePrefer:t.layoutprefer?t.layoutprefer:"2x1",zoom:t.zoom,textSizePrefer:jIsNumber(t.textsizeprefer)?Number(t.textsizeprefer):2,textFontPrefer:t.textfontprefer?t.textfontprefer:"a",treeBoxType:"ajax"===t.treetype?"ajax":"inline"===t.treetype&&"inline",treeBoxInitState:"visible"===t.treestate&&"visible",gotoIDX:jIsNumber(t.gotopage)?parseInt(t.gotopage,10):-1,queryString:JSON.parse(t.query),urlTracking:{package:t.trackingpackage,page:t.trackingpage},section:t.section,root:t.root,position:t.package,downloadFormats:{pdf:"-1"!==t.downloadpdf,djvu:"-1"!==t.downloaddjvu},gfx:{defw:jIsNumber(t.defw)?parseInt(t.defw,10):1e3,defh:jIsNumber(t.defh)?parseInt(t.defh,10):1400,minh:jIsNumber(t.minh)?parseInt(t.minh,10):1400,maxh:jIsNumber(t.maxh)?parseInt(t.maxh,10):1400},fixeven:toBoolean(t.fixeven),user:t.user},e=jQuery.extend(!0,{},o,e),new kViewer(a,e)})},$(function(e){jQuery.each($(".viewer--root"),function(e,t){setTimeout(function(){$(t).kViewerRun({debug:!0})},200*e)}),document.addEventListener("gesturechange",function(e){(e.originalEvent||e).scale>1&&(e.originalEvent||e).preventDefault()},{passive:!1})}),kViewer.count=0,kViewer.defaults={root:"rpc/viewer",version:"2.0",debug:!1,url:null,urlTracking:[],ctrlPageGo:-1,gotoIDX:-1,queryString:"",treeBoxType:"ajax",viewModes:{gfx:!1,html:!1},textFeatures:{searchable:!1,copyable:!1},viewModePrefer:"gfx",layoutModes:{"1x1":!0,"2x1":!0},layoutModePrefer:"2x1",textFontPrefer:"a",treeBoxInitState:"visible",textSizePrefer:2,gfx:{defw:1,defh:1},zoom:{gfx:{"1x1":{level:100,_w:!1,_h:!0},"2x1":{level:100,_w:!0,_h:!1}},html:{"1x1":{level:100},"2x1":{level:100}}},position:"left",downloadFormats:{pdf:!1,djvu:!1},section:"library"},jQuery.fn.kViewerRun.defaults=kViewer.defaults,jQuery.extend(kViewer.prototype,{_nop:function(){},_getInitPage:function(){var e,t,o=0;if(arguments.length>0&&void 0!==arguments[0]&&arguments[0])if(this.settings.gotoIDX<0&&this.settings.ctrlPageGo<0)e=$(this["ctrl-nav-page"][this.pageIDY]).nextAll(".nav-page-hl"),t=$(this["ctrl-nav-page"][this.pageIDX]).prevAll(".nav-page-hl"),$(this["ctrl-nav-page"][this.pageIDX]).hasClass("nav-page-hl")||$(this["ctrl-nav-page"][this.pageIDY]).hasClass("nav-page-hl")?o=this.pageIDX:e.length?o=Number($(e.first()).attr("data-rel")):t.length&&(o=Number($(t.last()).attr("data-rel")));else{this.settings.gotoIDX=this.settings.ctrlPageGo>=0&&this.settings.gotoIDX<0?this._getPageOrd(this.settings.ctrlPageGo):this.settings.gotoIDX;var a=$(this["ctrl-nav-page"][this.settings.gotoIDX]);o=a.hasClass("nav-page-hl")?Number(a.attr("data-rel"))||0:Number($(a.nextAll(".nav-page-hl")[0]).attr("data-rel"))||0}else o=this.settings.gotoIDX>=0?this.settings.gotoIDX:this._getPageOrd(this.settings.ctrlPageGo),this.gotoDone=!0;return this["viewport-gfx-pages"][this.pageIDX]||(this.pageIDX=0,this.pageIDY=0),o},_getPageOrd:function(e){var t=this["ctrl-nav-page"].filter(function(t,o){return $(o).text().toLowerCase()===String(e)}).first();return t&&t.attr("data-rel")?Number(t.attr("data-rel")-this.viewPortState.fixeven):0},_mobile:function(){var e,t,o,a,i,r=null!==(e=this.viewPortState)&&void 0!==e?e:{};return r.isMobile=null===(t=device)||void 0===t?void 0:t.mobile(),r.isTablet=null===(o=device)||void 0===o?void 0:o.tablet(),r.isLS=null===(a=device)||void 0===a?void 0:a.landscape(),r.isPR=null===(i=device)||void 0===i?void 0:i.portrait(),null==r?void 0:r.isMobile},_htmlTemplate:function(e,t){switch(e){case"glyph":return'<svg class="glyph-'.concat(t,'"><use xlink:href="#').concat(t,'"></use></svg>');case"copytoolbar":return'<span class="copy--toolbar page--toolbar">\n\t\t\t\t\t\t\t<button class="ui--button sys--button do--copy tip sys--tip" title="Скопировать">'.concat(this._htmlTemplate("glyph","g-copy"),'</button>\n\t\t\t\t\t\t\t<button class="ui--button sys--button do--copied tip sys--tip" title="Скопировано">').concat(this._htmlTemplate("glyph","g-copied"),'</button>\n\t\t\t\t\t\t\t<button class="ui--button sys--button do--copied-bg">').concat(this._htmlTemplate("glyph","g-copy-solid"),"</button>\n\t\t\t\t\t\t</span>");case"favtoolbar":return'<span class="fav--toolbar page--toolbar">\n\t\t\t\t\t\t\t<button class="ui--button sys--button do--fav tip sys--tip" title="Добавить страницу в закладки">'.concat(this._htmlTemplate("glyph","g-fav"),'</button>\n\t\t\t\t\t\t\t<button class="ui--button sys--button do--faved tip sys--tip" title="Добавлено">').concat(this._htmlTemplate("glyph","g-faved"),"</button>\n\t\t\t\t\t\t</span>");default:return""}},_urlEscapeHash:function(e){var t=e.replace(/[#]/g,"");return t=encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}}),$.extend(kViewer.prototype,{ldrInit:function(){this.$elviewer,$(window),this.eventNS},ldrFetchTree:function(){this.treeBoxState.valid||"ajax"===this.treeBoxState.type||(this["tree-links"]=this["tree-data-list"].find("a"),this.treeBoxState.valid=!0,this.hlSync(),this.trbSync(null,{forceTreeSync:!0}))}});var _NSNOTIFIER="data-notifier",_TNOTIFIER=7e3;jQuery.extend(kViewer.prototype,{setupNotifier:function(){var e,t=this;t.notifierState={dom:{i18n:{},approot:t.approot,root:t.bookroot,window:t.approot.find("[".concat(_NSNOTIFIER,"]")),msgbox:t.approot.find("[".concat(_NSNOTIFIER,"] [data-msg-box]")),timer:null,timeout:_TNOTIFIER}};var o=t.notifierState;o.dom.i18n=JSON.parse(null!==(e=o.dom.window.attr("data-notifier"))&&void 0!==e?e:"{}"),o.dom.window.on("click".concat(NS),function(e){t.notifierMessageBox()})},notifierMessageBox:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=["error","fetching-hlboxes","fetching-pubtext","loading-viewport","found","empty","ok","info","copied","faved","unfaved"].map(function(e){return"state--".concat(e)}).join(" "),i=this,r=i.notifierState;if(clearTimeout(r.dom.timer),r.dom.window.removeClass(a),e&&(r.dom.timer=setTimeout(function(){i.notifierMessageBox()},r.dom.timeout),e&&(r.dom.window.addClass("state--".concat(e)),t))){var n,s=null!==(n=r.dom.i18n[t])&&void 0!==n?n:e;r.dom.msgbox.html(s.replace(/{\w+}/g,function(e){return o[e.slice(1,-1)]}))}}}),jQuery.extend(kViewer.prototype,{hlInitState:function(){this.highlighterState={origin:"auto",exists:!0,count:0,hldata:{valid:!1,stats:{boxes:0,pages:0},opus:{},pages:{},pub:{}},pages:[],fixeven:this.settings.fixeven?1:0,valid:!1,query:this.settings.queryString,exquery:null,cleanquery:this._urlEscapeHash(this.settings.queryString),fetching:!1,fetcher:null},this.hlAttach(),this.highlighterState.enabled=!0},hlAttach:function(){var e=this;e.highlighterState;$(window).on("search:do:external",function(t,o,a,i){e.hlFetchBoxes({query:o})}).on("search:clear:external",function(t,o){e.hlUnmark(!0)})},hlMark:function(){var e,t=this,o=t.highlighterState,a=null===(e=o.hldata)||void 0===e||null===(e=e.stats)||void 0===e?void 0:e.pages;if(!a)return!1;t.$elviewer.removeClass("is-hlnav-hidden"),a&&Object.entries(o.hldata.pages).forEach(function(e){var a=_slicedToArray(e,2),i=a[0];a[1];$(t["ctrl-nav-page"][parseInt(i)+o.fixeven]).addClass("nav-page-hl")}),t.vpSync(),t.ctrlSync(),t.trbSync(),"auto"===o.origin?t.settings.gotoIDX<0?t.ctrlPageGo("current-next-hl"):t.ctrlPageGo(null):t.ctrlPageGo("current-next-hl")},hlUnmark:function(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],o=this.highlighterState;null===(e=o.hldata)||void 0===e||null===(e=e.stats)||void 0===e||e.pages;this.$elviewer.addClass("is-hlnav-hidden"),$(this["ctrl-nav-page"]).filter(".nav-page-hl").removeClass("nav-page-hl"),$(this["ctrl-nav-pager"]).removeClass("is-query-hl"),this.$elviewer.find(".hl--wrapper").remove(),jQuery.each(this["viewport-gfx-pages"],function(e,t){$(t).data("hlparsed",null)}),jQuery.each(this["viewport-html-contents"].find("mark"),function(e,t){for(var o=t.parentNode;t.firstChild;)o.insertBefore(t.firstChild,t);o.removeChild(t)}),this["viewport-html-contents"].find(".hlnav").remove(),t&&(o.hldata=null,o.valid=!1,o.query=null,o.exquery=null,o.cleanquery=null,this.vpSync(),this.ctrlSync(),this.trbSync(),this.vpGfxLoadVisiblePages())},hlSync:function(){this.highlighterState},hlFetchBoxes:function(){var e,t,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,a=this,i=a.viewPortState,r=a.highlighterState,n=null!==(e=null==o?void 0:o.query)&&void 0!==e?e:r.query,s=$("header");if(r.loading||!n||n.length<2||n===r.exquery)return n===r.exquery&&a.ctrlPageGo("current-next-hl"),void $(window).trigger("search:did:external",[n]);r.fetching=!0,a.hlUnmark(),a.notifierMessageBox("fetching-hlboxes"),a.setAppState("fetching-hlboxes"),r.fetcher=fetch("//".concat(HOSTS.this,"/").concat(a.settings.root,"/hl/?url=").concat(a.settings.url,"&query=").concat((t=n,encodeURIComponent(function(e){return null==e?void 0:e.replace(/[#?]/g,"")}(null!=t?t:""))))).then(function(e){var t;return r.fetching=!1,null!==(t=e.json())&&void 0!==t?t:new Promise.reject({})}).then(function(e){if(!e.valid)throw new Error("highlighter.json.invalid");r.hldata=e,r.valid=e.valid,r.exquery=r.query,r.query=n,r.cleanquery=a._urlEscapeHash(n)}).catch(function(e){return a.notifierMessageBox("error"),r.hldata=null,r.valid=null,Promise.resolve(e)}).then(function(){var e,t,o;null!==(e=r.hldata)&&void 0!==e&&null!==(e=e.stats)&&void 0!==e&&e.boxes?(a.notifierMessageBox("found","found",{PG:null===(t=r.hldata)||void 0===t||null===(t=t.stats)||void 0===t?void 0:t.pages,WRD:null===(o=r.hldata)||void 0===o||null===(o=o.stats)||void 0===o?void 0:o.boxes}),a.hlMark(),i.html.loaded?(i.html.valid=!1,i.html.loaded=!1,a.vpHtmlLoadDoc()):a.setAppState("active")):(a.notifierMessageBox("empty"),a.setAppState("active"))}).finally(function(){r.origin="manual",$(window).trigger("search:did:external",[r.query]),s.addClass("state--search")})}}),jQuery.extend(kViewer.prototype,{initCopierState:function(){var e=this;e.textCopierState={fetching:!1,fetcher:null,pagetext:null},e.$elviewer.on("click",".copy--toolbar",function(t){e.ctrlHideBoxes(t),e.cyCopyPageText(t.currentTarget)})},cyCopyPageText:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=this,o=t.textCopierState,a=$(e),i=a.closest(".copy--toolbar"),r=a.closest("[data-rel]"),n=null==r?void 0:r.data("rel");if(o.fetching||null===(null!=n?n:null))return!1;o.fetching=!0,o.fetcher=fetch("//".concat(HOSTS.this,"/").concat(t.settings.root,"/cp/?url=").concat(t.settings.url,"&page=").concat(n)).then(function(e){var t;return o.fetching=!1,null!==(t=e.json())&&void 0!==t?t:new Promise.reject({})}).then(function(e){if(!e.valid||!e.pagetext&&!e.pagehtml)throw new Error("textcopier.json.invalid");o.pagetext=e.pagetext,o.pagehtml=e.pagehtml}).catch(function(e){return t.notifierMessageBox("error"),o.pagetext=null,o.pagehtml=null,Promise.resolve(e)}).then(function(){var e;t.notifierMessageBox(null!==(e=copy2clip)&&void 0!==e&&e(o.pagehtml,o.pagetext)?"copied":"error")}).finally(function(){o.pagetext=null,i.addClass("is--copied"),setTimeout(function(e){i.removeClass("is--copied")},2e3)})}}),jQuery.extend(kViewer.prototype,{bmbInitState:function(){var e,t,o=this;o.bookmarksState={manager:null!==(e=window.XDStorage)&&void 0!==e?e:null,url:"",loaded:!1,enabled:!1,list:{},count:0,maxcolor:1,fixeven:o.settings.fixeven?1:0,$menuItem:o["ctrl-tb-bookmarks"],pollTimeout:throttleBookmarksLoad,pollTimer:null,eventsAttached:!1,_key:function(e){var t,o;return"".concat(null===(t=kbmsys)||void 0===t||null===(t=t.schema)||void 0===t?void 0:t.view).concat(null===(o=kbmsys)||void 0===o?void 0:o.sep).concat(e)}};var a=o.bookmarksState;$(document).on("click",".bm--link",function(e){var t,i,r=$(e.currentTarget),n=r.closest(".box--bookmarks"),s=n.find(".bm--link").length,l=null!==(t=r.attr("data-rel"))&&void 0!==t?t:0,c=null===(i=$(e.target).get(0))||void 0===i?void 0:i.tagName.toLowerCase();o.ctrlHideBoxes(e),"ins"===c?(o.bmToggleItem(l,0,!0),s<2&&n.addClass("is-empty"),r.remove()):o.ctrlPageGo(a.fixeven+parseInt(l))}),o.$elviewer.on("click",".fav--toolbar",function(e){var t=$(e.currentTarget).closest("[data-rel]"),a=null==t?void 0:t.data("rel");o.ctrlHideBoxes(e),o.bmToggleItem(a)}),a.manager.init(null===(t=kbmsys)||void 0===t?void 0:t.xd).then(function(e){o.bmLoadList(),a.pollTimer=setInterval(function(e){o.bmLoadList()},a.pollTimeout),a.enabled=!0})},bmLoadList:function(){var e,t=this,o=t.bookmarksState;if(!o.manager)return!1;o.manager.getItem(o._key(t.settings.url)).then(function(a){var i;o.loaded=!0,e=null;try{e=JSON.parse(a)}catch(t){console.warn(t),e={bm:{}}}null!==(i=e)&&void 0!==i&&i.bm&&JSON.stringify(e.bm)!==JSON.stringify(o.list)&&(o.list=e.bm),t.bmActivate()})},bmSaveList:function(){var e=this,t=e.bookmarksState;if(null==t||!t.enabled)return!1;t.manager.setItem(t._key(e.settings.url),JSON.stringify({bm:t.list})).then(function(t){e.bmUpdateState()})},bmActivate:function(){var e=this.bookmarksState;if(!e.loaded)return!1;e.enabled=!0,this.bmUpdateList()},bmAddItem:function(e,t){var o=this.viewPortState,a=this.bookmarksState,i=this.highlighterState;if(null==a||!a.enabled)return!1;a.list[e]={rel:e,color:t,hl:this["ctrl-nav-page"].eq(e+(o.fixeven?1:0)).hasClass("nav-page-hl")?i.query:""},this.bmSaveList()},bnRemoveItem:function(e,t){var o=this.bookmarksState;return!(null==o||!o.enabled)&&(void 0!==o.list[e]&&(delete o.list[e],void this.bmSaveList()))},bmUpdateList:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var e=this,t=e.bookmarksState;if(null==t||!t.enabled)return!1;t.count=0,jQuery.each(t.list,function(o,a){e.bmToggleItem(o,a.color,!1),parseInt(a.color)>0&&t.count++}),e.bmUpdateState()},bmToggleItem:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=(arguments.length>3&&void 0!==arguments[3]&&arguments[3],this.bookmarksState);if(null==a||!a.enabled)return!1;var i=$('.fav--toolbar[rel="'.concat(e,'"]')),r=this["viewport-html-iframe-contents"]?this["viewport-html-iframe-contents"].find('.fav--toolbar[data-rel="'.concat(e,'"]')):$();return!(!i.length&&!r.length)&&(void 0===t&&(t=(t=Number(this.bmAddItemByPageOrd(e,"color")))>=a.maxcolor?0:t+1),0===t&&delete a.list[e],i.attr("data-state",t),r.attr("data-state",t),!!o&&(this.bmAddItem(e,t),0===t&&(this.notifierMessageBox("unfaved"),this.bnRemoveItem(e)),1===t&&this.notifierMessageBox("faved"),void this.bmUpdateState()))},bmAddItemByPageOrd:function(e,t){var o=this.bookmarksState;if(null==o||!o.enabled||null===(null!=e?e:null))return!1;var a=o.list[e];return null===(null!=a?a:null)?t?"":{}:t?a[t]:a},bmUpdateState:function(){!(arguments.length>0&&void 0!==arguments[0])||arguments[0];var e,t=this.bookmarksState,o=Object.keys(null!==(e=null==t?void 0:t.list)&&void 0!==e?e:{}).length;if(null==t||!t.enabled||!t.list)return!1;$("html").addClass("state--bookmarks")[o?"addClass":"removeClass"]("state--bookmarked"),$(window).trigger("datastate:set",["viewer:bmlist",{idobject:this.settings.url,bmlist:LZString?LZString.compressToBase64(JSON.stringify(t.list)):JSON.stringify(t.list)}])}});var NSPREF="viewerprefs";jQuery.extend(kViewer.prototype,{uacSaveSettings:function(){var e=this.viewPortState,t={layoutModePrefer:e.layoutMode,textSizePrefer:e.html.textSize,textFontPrefer:e.html.textFont,zoom:e.zoom};if("undefined"==typeof Storage)return!1;localStorage.setItem("".concat(NSPREF).concat(NS),JSON.stringify(t))},uacLoadSettings:function(){return"undefined"!=typeof Storage&&(JSON.parse(localStorage.getItem("".concat(NSPREF).concat(NS)))||{})},authLoadSettings:function(e){var t={};return null!=e&&e.uuid&&null!=e&&e.settings,t}}),jQuery.extend(kViewer.prototype,{srchHandler:function(e){var t=e.data.self;t.viewPortState;t.ctrlHideBoxes(e)}}),jQuery.extend(kViewer.prototype,{}),jQuery.extend(kViewer.prototype,{ctrlInit:function(){var e,t,o,a,i=this,r=i.$elviewer,n=$(window),s=i.eventNS;for(e in i.domroot=$(document),i.controls={".tb-tree":{fnHandler:"trbToggleVisibility",eventType:"mouseup"},".tb-search":{fnHandler:"srchHandler",eventType:"mouseup"},".tb-view":{fnHandler:"vpToggleViewMode",eventType:"mouseup"},".tb-layout":{fnHandler:"vpToggleLayoutMode",eventType:"mouseup"},".nb-first":{fnHandler:"onNav",eventType:"mouseup",param:"first"},".nb-prev":{fnHandler:"onNav",eventType:"mouseup",param:"prev"},".nb-prev-hl":{fnHandler:"onNav",eventType:"mouseup",param:"prev-hl"},".nb-last":{fnHandler:"onNav",eventType:"mouseup",param:"last"},".nb-next":{fnHandler:"onNav",eventType:"mouseup",param:"next"},".nb-next-hl":{fnHandler:"onNav",eventType:"mouseup",param:"next-hl"},".nav-page":{fnHandler:"onNavPage",eventType:"mousedown"},".nav-pager":{fnHandler:"onPagesList",eventType:"mouseup"},".pz-zoom-in":{fnHandler:"onZoom",eventType:"mouseup",param:"+"},".pz-zoom-out":{fnHandler:"onZoom",eventType:"mouseup",param:"-"},".pz-zoom-w":{fnHandler:"onZoom",eventType:"mouseup",param:"*"},".pz-zoom-h":{fnHandler:"onZoom",eventType:"mouseup",param:"/"},".pz-texsize-dec":{fnHandler:"onTextSize",eventType:"mouseup",param:"-"},".pz-texsize-inc":{fnHandler:"onTextSize",eventType:"mouseup",param:"+"},".pz-textwidth-dec":{fnHandler:"onWidth",eventType:"mouseup",param:"["},".pz-textwidth-inc":{fnHandler:"onWidth",eventType:"mouseup",param:"]"},".pv-font-a":{fnHandler:"onTextFont",eventType:"mouseup",param:"a"},".pv-font-b":{fnHandler:"onTextFont",eventType:"mouseup",param:"b"},".pz-rot-cw":{fnHandler:"onPageRotate",eventType:"mouseup",param:"cw"},".pz-rot-ccw":{fnHandler:"onPageRotate",eventType:"mouseup",param:"ccw"},".li-close":{fnHandler:"onClose",eventType:"mouseup",param:i.settings.position},".close-box.close-tree-box":{fnHandler:"trbHide",eventType:"mouseup"}},i["help-box"]=$('[data-type="help-box"]'),i["tree-box"]=$(".viewer--tree"),i["tree-box-container"]=i["tree-box"].find(".data-container"),i["tree-data-list"]=i["tree-box"].find(".data-list"),i["tree-links"]=i["tree-data-list"].find("a"),i["pages-list"]=$(".toolbar--popup.pages--list"),i["pages-data-container"]=i["pages-list"].find(".data-container"),i["pages-data-list"]=i["pages-list"].find(".data-list"),i["page-num"]=$(".page--num"),i.toolbar=$(".viewer--toolbar"),i["viewport-gfx"]=$('[data-view-mode="gfx"]'),i["viewport-gfx-container"]=i["viewport-gfx"].find(".data-container"),i["viewport-gfx-contents"]=i["viewport-gfx"].find(".data-contents"),i["viewport-gfx-pages"]=i["viewport-gfx-contents"].find(".page-gfx"),i["viewport-html"]=$('[data-view-mode="html"]'),i["viewport-html-container"]=i["viewport-html"].find(".data-container"),i["viewport-html-contents"]=i["viewport-html-container"].find(".data-contents"),i["viewport-html-iframe"]=null,i["viewport-ruler"]=$('[data-view-mode="ruler"]'),i["bookmarks-list"]=$("[data-type=popup-bookmarks]"),i["bookmarks-list-contents"]=i["bookmarks-list"].find(".data-list"),i["vp-center"]=$(".vp-center"),i["vp-scrollers"]=document.querySelector(".viewer--viewport .data-container"),r.on("mousedown"+s,"",{self:i},function(){return i.onMouseDown.apply(i,arguments)}).on("mouseenter"+s,"",{self:i},function(){return i.onRollOver.apply(i,arguments)}).on("mouseover"+s,"",{self:i},function(){return i.onRollOver.apply(i,arguments)}).on("mouseup"+s,"",{self:i},function(){return i.onClick.apply(i,arguments)}),n.on("keyup"+s,"",{self:i},function(){return i.onKeyboard.apply(i,arguments)}).on("resize"+s+" orientationChange"+s,function(e){}),i.resizeObserver=new ResizeObserver(function(e){var t,o=_createForOfIteratorHelper(e);try{for(o.s();!(t=o.n()).done;)t.value}catch(e){o.e(e)}finally{o.f()}window.dispatchEvent(new CustomEvent("tippy:forcehide:ng")),i.$elviewer.addClass("no-transition"),i.ctrlHideBoxes(),i.resizeInProgress=!0,i.vpResize(!1,!0)}),i.resizeObserver.observe(document.querySelector(".app--container")),i.resizeObserver.observe(document.querySelector(".viewer--tree")),i.drgGFX={clicked:!1,allowClick:!0,mouseX:-1,mouseY:-1},i["viewport-gfx-container"].on("mousewheel".concat(s),"",{self:i},function(e){var t=e.data.self;if(t.ctrlHideBoxes(e),e.altKey&&e.originalEvent.deltaY)return t.vpGfxZoom(e.originalEvent.deltaY<0?"+":"-"),e.preventDefault(),e.stopPropagation(),!1}).on("scroll".concat(s),"",{self:i},function(e){var t=e.data.self;if(t.scrollTimer&&clearTimeout(t.scrollTimer),e.target.deflectScrollEvent||t.resizeInProgress||t.resizeTimer)return!1;t.scrollTimer=setTimeout(function(){t.vpFindCurPageXY(),t.scrollTimer=null},throttleDetectScroll)}).on("mousemove".concat(s),"",{self:i},function(e){var t=e.data.self;t.resizeInProgress||t.resizeTimer||t.drgGFX.clicked&&(t["viewport-gfx-container"].scrollLeft(t["viewport-gfx-container"].scrollLeft()+(t.drgGFX.mouseX-e.pageX)),t["viewport-gfx-container"].scrollTop(t["viewport-gfx-container"].scrollTop()+(t.drgGFX.mouseY-e.pageY)),t.drgGFX.mouseX=e.pageX,t.drgGFX.mouseY=e.pageY)}).on("mousedown".concat(s),"",{self:i},function(e){var t=e.data.self;t.resizeInProgress||t.resizeTimer||t.isMobile||(t["viewport-gfx-container"].addClass("is-draggable"),t.drgGFX.clicked=!0,t.drgGFX.mouseX=e.pageX,t.drgGFX.mouseY=e.pageY)}).on("mouseup".concat(s," mouseleave").concat(s),"",{self:i},function(e){var t=e.data.self;t["viewport-gfx-container"].removeClass("is-draggable"),t.drgGFX.clicked=!1,t.drgGFX.allowClick=!0}),i["viewport-gfx-pages"].on("mouseup".concat(s),"",{self:i},function(e){}),i["viewport-html-container"].on("mousewheel".concat(s),"",{self:i},function(e){e.data.self.ctrlHideBoxes(e)}).on("scroll".concat(s),"",{self:i},function(e){var t=e.data.self;if(t.scrollTimer&&clearTimeout(t.scrollTimer),e.target.deflectScrollEvent||t.resizeInProgress||t.resizeTimer)return!1;t.scrollTimer=setTimeout(function(){t.vpFindCurPageXY(),t.scrollTimer=null},throttleDetectScroll)}),i.$elviewer.on("click".concat(s),".hlnav",function(e){return e.preventDefault(),i.ctrlPageGo("anchor-hl",e)}),i.controls)i.controls.hasOwnProperty(e)&&(t=i.controls[e].fnHandler,o=i.controls[e].eventType,a=i.controls[e].param,t&&o&&(i["ctrl-".concat(e.replace(".","").replace(" ","-"))]=$(e),$(document).on("".concat(o).concat(s),e,{self:i,param:a},i[t])))},ctrlPageGo:function(e){var t,o,a,i,r,n,s,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{src:"ctrlPageGo"},d=this.viewPortState,u=(d.fixeven,"2x1"===d.layoutMode?2:1);if(e&&e.target&&"span"===e.target.nodeName.toLowerCase())s=$(e.target),this.pageIDX=Number(s.attr("data-rel")),c.force=!0;else if("number"==typeof e)this.pageIDX=Math.max(e,d.fixeven);else if("string"==typeof e)switch(e){case"next":this.pageIDX=Math.min(this.pageIDX+u,this.pageMAX-1);break;case"prev":this.pageIDX=Math.max(this.pageIDX-u,0);break;case"first":this.pageIDX=0;break;case"last":this.pageIDX=this.pageMAX-1;break;case"current-next-hl":var h=$(this["ctrl-nav-page"][this.pageIDY]).eq(0);null!=h&&h.hasClass("nav-page-hl")?(this.pageIDX=Number($(h).attr("data-rel")),c.scrollToFirstHL="html"===d.viewMode):this.ctrlPageGo("next-hl");break;case"next-hl":var p=$(this["ctrl-nav-page"][this.pageIDY]).nextAll(".nav-page-hl").eq(0);p[0]?(this.pageIDX=Number($(p).attr("data-rel")),c.scrollToFirstHL="html"===d.viewMode):this.ctrlPageGo("prev-hl");break;case"prev-hl":var v=$(this["ctrl-nav-page"][this.pageIDX]).prevAll(".nav-page-hl").eq(0);v[0]&&(this.pageIDX=Number($(v).attr("data-rel")),c.scrollToLastHL="html"===d.viewMode);break;case"anchor-hl":var f=null!==(t=null==l||null===(o=l.currentTarget)||void 0===o||null===(o=o.href)||void 0===o?void 0:o.split("#")[1])&&void 0!==t?t:"x",g=null!==(a=l.currentTarget)&&void 0!==a&&a.id?this["viewport-html-marks"].toArray().findIndex(function(e){return e.id===l.currentTarget.id}):this["viewport-html-marks"].toArray().findIndex(function(e){return e.id===f}),m=null!==(i=l.currentTarget)&&void 0!==i&&i.id?null!==(r=this["viewport-html-marks"].get(g+1))&&void 0!==r?r:null:null!==(n=this["viewport-html-marks"].get(g))&&void 0!==n?n:null;return l.currentTarget&&(null==m||m.scrollIntoView({behavior:"smooth",block:"center",inline:"start"})),!1}this.pageIDX="2x1"===d.layoutMode?2*Math.trunc(this.pageIDX/2):this.pageIDX,this.pageIDY="2x1"===d.layoutMode?Math.min(this.pageIDX+1,this.pageMAX-1):this.pageIDX,this["viewport-gfx-pages"][this.pageIDX]||(this.pageIDX=0,this.pageIDY=0),this.ctrlHideBoxes(),this.vpSync(l,_objectSpread(_objectSpread({},c),{force:!0}))},ctrlSync:function(){var e,t,o=arguments.length>0&&void 0!==arguments[0]&&arguments[0],a=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=(arguments.length>2&&void 0!==arguments[2]&&arguments[2],this),r=i.viewPortState,n=r.fixeven?1:0;clearTimeout(i.timerSyncControls),i.timerSyncControls=setTimeout(function(){if(!a){i["ctrl-tb-tree"][i.settings.treeBoxType?"removeClass":"addClass"]("is-disabled"),i["ctrl-tb-tree"][i.treeBoxState.visible?"addClass":"removeClass"]("is-active"),i["ctrl-tb-search"][i.highlighterState.visible?"addClass":"removeClass"]("is-active"),jQuery.each([i["ctrl-nb-next"],i["ctrl-nb-next-hl"],i["ctrl-nb-last"]],function(e,t){t[i.pageIDX<i.pageMAX-1?"removeClass":"addClass"]("is-disabled")}),jQuery.each([i["ctrl-nb-prev"],i["ctrl-nb-prev-hl"],i["ctrl-nb-first"]],function(e,t){t[i.pageIDX>n?"removeClass":"addClass"]("is-disabled")});var s=$(i["ctrl-nav-page"][i.pageIDY]).nextAll(".nav-page-hl"),l=$(i["ctrl-nav-page"][i.pageIDX]).prevAll(".nav-page-hl");for(i["ctrl-nb-next-hl"][s.length?"removeClass":"addClass"]("is-disabled"),i["ctrl-nb-prev-hl"][l.length?"removeClass":"addClass"]("is-disabled"),e=!1,i["ctrl-nav-page"].removeClass("is-active"),t=i.pageIDX;t<=i.pageIDY;t++)$(i["ctrl-nav-page"][t]).addClass("is-active"),$(i["ctrl-nav-page"][t]).hasClass("nav-page-hl")&&(e=!0);i["ctrl-nav-pager"][e?"addClass":"removeClass"]("is-query-hl")}if(i.pageMAX){var c=[],d=$(i["ctrl-nav-page"][i.pageIDX]).html(),u=$(i["ctrl-nav-page"][i.pageIDY]).html();c.push(d),d!==u&&""!==u&&c.push(u),i["page-num"].html(c.join('<span class="sep">—</span>')),$('[data-type="book-glowbar"] ins').css({width:Math.ceil((i.pageIDX<i.pageMAX/2?i.pageIDX:i.pageIDY)/(i.pageMAX-1)*100)+"%"})}i["ctrl-tb-search"][r.textFeatures.searchable?"removeClass":"addClass"]("is-restricted"),i["ctrl-tb-view"][r.viewModes.gfx&&r.viewModes.html?"removeClass":"addClass"]("is-restricted"),i["ctrl-tb-layout"][r.viewModes.gfx||r.viewModes.html?"removeClass":"addClass"]("is-disabled"),i["ctrl-pv-font-a"]["a"===r.html.textFont?"addClass":"removeClass"]("is-disabled"),i["ctrl-pv-font-b"]["b"===r.html.textFont?"addClass":"removeClass"]("is-disabled"),i["ctrl-pz-zoom-in"][r.zoom.gfx[r.layoutMode].level<maxZoom[r.layoutMode]?"removeClass":"addClass"]("is-disabled"),i["ctrl-pz-zoom-out"][r.zoom.gfx[r.layoutMode].level>minZoom[r.layoutMode]?"removeClass":"addClass"]("is-disabled"),i["ctrl-pz-zoom-w"][r.zoom.gfx[r.layoutMode]._w?"addClass":"removeClass"]("is-disabled"),i["ctrl-pz-zoom-h"][r.zoom.gfx[r.layoutMode]._h?"addClass":"removeClass"]("is-disabled"),i["ctrl-pz-texsize-dec"][0===r.html.textSize?"addClass":"removeClass"]("is-disabled"),i["ctrl-pz-texsize-inc"][r.html.textSize>=4?"addClass":"removeClass"]("is-disabled"),i["ctrl-pz-textwidth-inc"][r.zoom.html.level<maxHTMLWidth&&"2x1"!==r.layoutMode?"removeClass":"addClass"]("is-disabled"),i["ctrl-pz-textwidth-dec"][r.zoom.html.level>minHTMLWidth&&"2x1"!==r.layoutMode?"removeClass":"addClass"]("is-disabled");var h="1x1"===r.layoutMode&&"gfx"===r.viewMode&&i["viewport-gfx-pages"][i.pageIDX]&&!$(i["viewport-gfx-pages"][i.pageIDX]).hasClass("ls-page")&&!$(i["viewport-gfx-pages"][i.pageIDX]).hasClass("ns-page");i["ctrl-pz-rot-cw"][h?"removeClass":"addClass"]("is-disabled"),i["ctrl-pz-rot-ccw"][h?"removeClass":"addClass"]("is-disabled"),!a&&o&&i.ctrlHideBoxes(),window.dispatchEvent(new CustomEvent("tippy:hide:ng")),i.urlManager("update")},throttleSyncControls)},ctrlHideBoxes:function(e){var t=e&&e.data&&e.data.self?e.data.self:this,o=(t.viewPortState,e||{});t.isActive&&o.target!==t["ctrl-nav-pager"][0]&&t["ctrl-nav-pager"].removeClass("is-active")}}),jQuery.extend(kViewer.prototype,{onClick:function(e){e.data.self},onMouseDown:function(e){},onRollOver:function(e){window.activeBook=e.data.self},onKeyboard:function(e){var t=e&&e.data&&e.data.self?e.data.self:this,o=t.viewPortState;if(t.isActive&&window.activeBook===t&&!(e&&e.target&&e.target.tagName&&"input"===e.target.tagName.toLowerCase()))switch(e.key){case"ArrowLeft":t.ctrlPageGo(e.ctrlKey?"prev-hl":"prev"),e.preventDefault();break;case"ArrowRight":t.ctrlPageGo(e.ctrlKey?"next-hl":"next"),e.preventDefault();break;case"+":case"=":case"-":case"/":case"*":"gfx"===o.viewMode&&t.vpGfxZoom(e.key),"html"===o.viewMode&&t.vpHtmlTextSize(e.key);break;case"Escape":case"Esc":var a=$(".ph-app");if(a.hasClass("is-help-visible"))return a.removeClass("is-help-visible"),e.preventDefault(),!1;t.ctrlHideBoxes(e);break;case"1":t.vpSetLayoutMode("1x1");break;case"2":t.vpSetLayoutMode("2x1");break;default:switch(e.keyCode){case 77:t.vpToggleViewMode(e);break;case 76:t.vpToggleLayoutMode(e);break;case 49:t.vpSetLayoutMode("1x1");break;case 50:t.vpSetLayoutMode("2x1");break;case 192:case 84:t.trbToggleVisibility(e);break;case 72:case 73:break;case 70:e.ctrlKey||(e.preventDefault(),$(".header--sys .do--searchtrigger").trigger("click".concat(NS)));break;case 80:case 69:case 66:break;case 188:case 219:t.vpHtmlWidthDoc("[");break;case 190:case 221:t.vpHtmlWidthDoc("]");break;case 90:t.vpGfxRotatePage("ccw");break;case 88:t.vpGfxRotatePage("cw")}}},onNav:function(e){var t=e.data.self,o=e.data.param;t.ctrlPageGo(o)},onZoom:function(e){var t=e.data.self,o=e.data.param;return t.vpGfxZoom(o),e.preventDefault(),e.stopPropagation(),!1},onPageRotate:function(e){var t=e.data.self,o=e.data.param;return t.vpGfxRotatePage(o),e.preventDefault(),e.stopPropagation(),!1},onWidth:function(e){var t=e.data.self,o=e.data.param;return t.vpHtmlWidthDoc(o),e.preventDefault(),e.stopPropagation(),!1},onPagesList:function(e){var t=e.data.self,o=t["ctrl-nav-pager"].hasClass("is-active");if(e.target!==t["ctrl-nav-pager"][0])return!1;o?t["ctrl-nav-pager"].removeClass("is-active"):(t["pages-list"].delayShow(),setTimeout(function(){t["ctrl-nav-pager"].addClass("is-active")},1),$(t["ctrl-nav-page"][t.pageIDX]).scrollIntoViewIfNeeded(!0))},onNavPage:function(e){return e.data.self.ctrlPageGo(e),e.stopPropagation(),!1},onTextSize:function(e){var t=e.data.self,o=e.data.param;return!$(e.currentTarget).hasClass("is-restricted")&&(t.vpHtmlTextSize(o),e.preventDefault(),e.stopPropagation(),!1)},onTextFont:function(e){var t=e.data.self,o=e.data.param;return!$(e.currentTarget).hasClass("is-restricted")&&(t.vpHtmlTextFont(o),e.preventDefault(),e.stopPropagation(),!1)}}),jQuery.extend(kViewer.prototype,{trbInitState:function(e){var t=this["tree-box"],o=this.viewPortState;if(!this.settings.treeBoxType)return this.treeBoxState={exists:!1,type:!1};this.treeBoxState={exists:!!this.settings.treeBoxType,type:this.settings.treeBoxType,visible:"visible"===this.settings.treeBoxInitState&&!o.isMobile&&"kcms"!==e,valid:"ajax"!==this.settings.treeBoxType,ajaxloader:t.find(".side-loader"),enabled:!1,normalized:!1,eventsAttached:!1},this.treeBoxState.ajaxloader.hide(0),t.hide(0),this.treeBoxState.eventsAttached||this.trbInitListeners(),this.treeBoxState.enabled=!0},trbInitListeners:function(){var e=this,t=e["tree-box"],o=e.viewPortState,a=e.treeBoxState;t.on("mouseup"+e.eventNS,".tree--collapse-all, .tree--expand-all",function(o){var a=$(o.currentTarget).hasClass("tree--expand-all");t.find("a.is-expandable, .tree-group[data-parent]")[a?"addClass":"removeClass"]("is-open-item"),e.trbSync(null,{forceTreeSync:!0,noTreeExpand:!0})}).on("mouseup"+e.eventNS,"a, ins",function(a){var i;(i=$(a.target).closest("a"))&&("ins"===a.currentTarget.tagName.toLowerCase()&&i.attr("data-child")?(t.find(".tree-group[data-parent="+i.attr("data-child")+"]").toggleClass("is-open-item"),i.toggleClass("is-open-item")):(e.ctrlPageGo(o.fixeven+(Number(i.attr("data-goto-page"))||0),a),o.isMobile&&o.isPR&&e.trbHide())),a.stopPropagation()}),t.tResize=null;var i={handleWidth:10,tracking:!1,startWidth:0,startX:0,target:null,maxWidth:0},r=function(e){return e.screenX};function n(e){var t,o;i.tracking&&(i.tracking=!1,null===(t=(o=e.target).releasePointerCapture)||void 0===t||t.call(o,e.pointerId))}document.body.addEventListener("pointerdown",function(e){var t=e.target.closest(".resize-treebox.resize-handle");if(t&&("mouse"!==e.pointerType||0===e.button)){e.preventDefault(),e.stopPropagation();var o=t.parentElement,a=function(e,t){return e instanceof HTMLElement&&t?e.querySelector(t):null}(o,t.dataset.target);a&&(i={handleWidth:t.offsetWidth,tracking:!0,startWidth:a.offsetWidth,startX:r(e),target:a,maxWidth:o.clientWidth-t.offsetWidth},t.setPointerCapture(e.pointerId))}},{passive:!1}),window.addEventListener("pointermove",function(e){i.tracking&&(e.preventDefault(),requestAnimationFrame(function(){var t=r(e)-i.startX,o=Math.min(i.startWidth+t,i.maxWidth);i.target.style.width="".concat(o,"px")}))},{passive:!1}),window.addEventListener("pointerup",function(e){return n(e)},!1),window.addEventListener("pointercancel",function(e){return n(e)},!1),a.eventsAttached=!0},trbToggleVisibility:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=e&&e.data&&e.data.self||e,a=o["tree-box"],i=(o.viewPortState,o.treeBoxState);if(!i.exists||o.resizeInProgress)return!1;i.visible=t||!i.visible,o.ctrlHideBoxes(e),i.visible?a.addClass("is-active"):a.removeClass("is-active"),o.vpResize(!1,!1,{src:"tree-box",action:i.visible?"addClass":"removeClass",param:"is-tree-pinned",norender:!0}),o[i.visible&&!i.valid?"ldrFetchTree":"trbSync"]()},trbHide:function(e){var t=e&&e.data&&e.data.self?e.data.self:this,o=t?t.treeBoxState:{};if(!o.exists||t.resizeInProgress)return!1;o.visible=!1,t.ctrlHideBoxes(e),t.vpResize(!1,!1,{src:"tree-box",action:o.visible?"addClass":"removeClass",param:"is-tree-pinned",norender:!0})},trbEnsureHidden:function(e){var t=e||this,o=t["tree-box"],a=t?t.treeBoxState:{};if(!a.exists)return!1;a.visible=!1,o.removeClass("is-active"),t.$elviewer.removeClass("is-tree-pinned")},trbSync:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this,a=o["tree-box"],i=[],r=null;o.treeBoxState.valid&&a.hasClass("is-active")&&o["ctrl-nav-page"][o.pageIDX]&&(clearTimeout(o.timerSyncTree),o.timerSyncTree=setTimeout(function(){jQuery.merge(i,$(o["ctrl-nav-page"][o.pageIDX]).attr("data-opera").split(" "));for(var n=o.pageIDX;n<=o.pageIDY;n++)i=jQuery.merge(i,$(o["ctrl-nav-page"][n]).attr("data-opera").split(" "));a.find("a.is-highlighted").removeClass("is-highlighted"),jQuery.each(i,function(e,t){a.find("[".concat("data-anchor",'="').concat(t,'"]')).addClass("is-highlighted"),r=a.find("[".concat("data-anchor",'="').concat(t,"\"]:not('.is-hidden')"))});var s=a.find("a.is-expandable:has(+ .tree-group:has(.is-highlighted))");s.addClass("is-highlighted"),t.noTreeExpand||(s.addClass("is-open-item"),jQuery.each(a.find("a.is-highlighted"),function(e,t){var o=$(t),i=o.attr("data-child"),r=$(a.find('[data-parent="'.concat(i,'"]')));o.addClass("is-open-item"),r.addClass("is-open-item"),jQuery.each($(t).parents("div.tree-group"),function(e,t){var o=$(t),i=o.attr("data-parent"),r=$(a).find('[data-child="'.concat(i,'"]'));o.addClass("is-open-item"),r.addClass("is-open-item"),$(t).addClass("is-open-item"),$(a.find('div[data-child="'+$(t).attr("data-parent")+'"]')).addClass("is-open-item")})})),$(r).scrollIntoViewIfNeeded(null===e||!e||t.forceTreeSync)},e?0:throttleSyncTree))}}),jQuery.extend(kViewer.prototype,{ptbCreate:function(e,t){var o=this.viewPortState,a=o.fixeven?1:0;if(e.data("toolbar"))e.data("toolbar");else{var i=$(this["ctrl-nav-page"][t+a]).hasClass("accmode--limited")?"limited":"public",r=o.textFeatures.copyable&&"public"===i?$(this._htmlTemplate("copytoolbar")).appendTo(e):null,n=$(this._htmlTemplate("favtoolbar")).appendTo(e),s=this.bmAddItemByPageOrd(t,"color");null==r||r.attr("rel",t),n.attr("rel",t).attr("data-state",!1===s?0:s),e.data("toolbar",!0)}}}),jQuery.extend(kViewer.prototype,{vpInitState:function(){this.settings,this.eventNS,$(window),$(document),this.$elviewer;this.isActive=!1,this.htmlLaunch=!1,this.pageIDX=0,this.pageIDY=0,this.pageMAX=this["ctrl-nav-page"].length,this.viewPortState={viewModes:this.settings.viewModes,viewMode:this.settings.viewModePrefer,isMobile:this._mobile(),layoutModes:this.settings.layoutModes,layoutMode:this.settings.layoutModePrefer,textFeatures:this.settings.textFeatures,zoom:this.settings.zoom,fixeven:this.settings.fixeven,gfx:{valid:!1,loaded:!1,fetching:!1,fetcher:null,defw:this.settings.gfx.defw,defh:this.settings.gfx.defh,minh:this.settings.gfx.minh,maxh:this.settings.gfx.maxh,curw:1,curh:1,scale:100,colCount:1,rowCount:1,gapY:0,pageSizes:[],pageSizesChunks:[]},html:{valid:!1,loaded:!1,fetching:!1,fetcher:null,pubtext:"",textSizesList:[0,1,2,3,4],textSize:Number(this.settings.textSizePrefer),textFontsList:["a","b","c"],textFont:this.settings.textFontPrefer,colCount:1,pageSizes:[],pageSizesChunks:[],curw:1}}},vpResize:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=this,i=a.viewPortState,r=(a.highlighterState,a["viewport-gfx-container"][0]),n=a["viewport-html-container"][0],s=null,l=null,c=a["viewport-gfx"][0],d=a["viewport-html"][0],u=c.clientWidth,h=c.clientHeight,p=d.clientWidth,v=d.clientHeight,f=i.gfx.curh,g=i.gfx.defh,m=i.gfx.defw,x=0,w={};if(r.deflectScrollEvent=!0,n.deflectScrollEvent=!0,i.gfx.valid=!t&&i.gfx.valid,i.html.valid=!t&&i.html.valid,a.ctrlSync(!1,!0),a._mobile(),e&&i.isMobile&&requestAnimationFrame(function(){"2x1"===i.layoutMode&&(i.layoutMode="1x1",i.zoom.html.level=100,a.$elviewer.removeClass("is-2x1-mode").addClass("is-1x1-mode"),a["viewport-gfx"].removeClass("mode-2x1").addClass("mode-1x1"),a["viewport-gfx-contents"].css("width",i.zoom.gfx[i.layoutMode].level+"%"),a["viewport-html"].removeClass("mode-2x1").addClass("mode-1x1"),a["viewport-html-contents"].css("width","100%")),a.treeBoxState.visible&&i.isPR&&!o.norender&&a.trbEnsureHidden()}),o&&o.action)return requestAnimationFrame(function(){a.$elviewer.addClass("is-resizing-viewport"),!o.norender&&i.isMobile}),setTimeout(function(){switch(o.action){case"addClass":case"removeClass":a.$elviewer[o.action](o.param),w.norender=o.norender;break;case"launchViewer":a.setAppState("active"),w.jump2page=!0;break;case"changeMode":w.jump2page=a.pageIDX,a.$elviewer.removeClass("gfx"===i.viewMode?"is-html-mode":"is-gfx-mode").addClass("is-"+i.viewMode+"-mode"),a["viewport-gfx"]["gfx"===i.viewMode?"addClass":"removeClass"]("is-active"),a["viewport-html"]["html"===i.viewMode?"addClass":"removeClass"]("is-active");break;case"changeLayout":a.$elviewer.removeClass("2x1"===i.layoutMode?"is-1x1-mode":"is-2x1-mode").addClass("is-"+i.layoutMode+"-mode"),a["viewport-gfx"].removeClass("mode-1x1 mode-2x1").addClass("mode-"+i.layoutMode),a["viewport-gfx-contents"].css("width",i.zoom.gfx[i.layoutMode].level+"%"),a["viewport-html"].removeClass("mode-1x1 mode-2x1").addClass("mode-"+i.layoutMode),a["viewport-html-contents"].css("width",i.zoom.html[i.layoutMode].level+"%"),a.pageIDX="2x1"===i.layoutMode?2*Math.trunc(a.pageIDX/2):a.pageIDX,a.pageIDY="2x1"===i.layoutMode?Math.min(a.pageIDX+1,a.pageMAX-1):a.pageIDX;break;case"vpGfxZoom":a["viewport-gfx-contents"].css("width",i.zoom.gfx[i.layoutMode].level+"%");break;case"vpHtmlWidthDoc":a["viewport-html-contents"].css("width",("2x1"===i.viewMode?100:i.zoom.html.level)+"%");break;case"vpHtmlTextFont":a["viewport-html-contents"].removeClass("font-family-a font-family-b font-family-c").addClass("font-family-"+i.html.textFont);break;case"vpHtmlTextSize":a["viewport-html-contents"].removeClass("font-size-0 font-size-1 font-size-2 font-size-3 font-size-4").addClass("font-size-"+i.html.textSize);break;case"pubTextLoad":a["viewport-html-contents"].removeClass("font-family-a font-family-b font-family-c").addClass("font-family-"+i.html.textFont),a["viewport-html-contents"].removeClass("font-size-0 font-size-1 font-size-2 font-size-3 font-size-4").addClass("font-size-"+i.html.textSize)}a.vpResize(!1,!1,w)},throttleViewportChange),!1;a.isActive?requestAnimationFrame(function(){a.resizeInProgress=!0,s=a["viewport-gfx-container"].outerWidth(!0),l=a["viewport-gfx-container"].outerHeight(!0),"gfx"!==i.viewMode||s===u&&l===h||(i.gfx.valid=!1),"html"!==i.viewMode||s===p&&l===v||(i.html.valid=!1),("gfx"===i.viewMode&&!i.gfx.valid||"html"===i.viewMode&&!i.html.valid)&&o.norender,a.vpValidate(),i.viewModes.gfx&&"gfx"===i.viewMode&&!i.gfx.valid&&(i.zoom.gfx[i.layoutMode]._h&&(x="1x1"===i.layoutMode?s:s/2,f=x*(g/m),i.zoom.gfx[i.layoutMode].level=l/f*100,a["viewport-gfx-contents"].css("width",1.02*i.zoom.gfx[i.layoutMode].level+"%")),setTimeout(function(){requestAnimationFrame(function(){i.gfx.pageSizes=[],i.gfx.pageSizesChunks=[],jQuery.each(a["viewport-gfx-pages"],function(e,t){var o=Number($(t).attr("data-rel"));i.gfx.pageSizes[o]={offsetTop:t.offsetTop,offsetHeight:t.offsetHeight,rel:o+i.fixeven}}),i.gfx.pageSizesChunks=new Array(Math.ceil(i.gfx.pageSizes.length/gfxChunckSize)).fill().map(function(e,t){return i.gfx.pageSizes.slice(t*gfxChunckSize,t*gfxChunckSize+gfxChunckSize)}),a.isActive&&(i.gfx.valid=!0,o.jump2page?!0===o.jump2page?(a.ctrlPageGo(a._getInitPage()),a.hlFetchBoxes()):a.ctrlPageGo(o.jump2page):a.vpSync(null,{src:"vpResize#gfx"}))})},5)),i.viewModes.html&&"html"===i.viewMode&&!i.html.valid&&(i.html.pageSizes=[],i.html.pageSizesChunks=[],setTimeout(function(){requestAnimationFrame(function(){jQuery.each(a["viewport-html-pages"],function(e,t){var o=Number($(t).attr("data-rel"));i.html.pageSizes[o]={offsetTop:t.offsetTop,offsetHeight:t.offsetHeight,rel:o+i.fixeven}}),i.html.pageSizesChunks=new Array(Math.ceil(i.html.pageSizes.length/htmlChunckSize)).fill().map(function(e,t){return i.html.pageSizes.slice(t*htmlChunckSize,t*htmlChunckSize+htmlChunckSize)}),a.isActive&&(i.html.valid=!0,o.jump2page?a.ctrlPageGo(o.jump2page):a.vpSync(null,{src:"vpResize#html"}))})},throttleDetectScroll)),setTimeout(function(){a.$elviewer.addClass("is-active").removeClass("no-transition "+(i.html.loaded?"is-loading-viewport":"")),i.gfx.loaded&&a["viewport-gfx"].removeClass("is-loading"),i.html.loaded&&a["viewport-html"].removeClass("is-loading"),i.isMobile||a.ctrlHideBoxes(),requestAnimationFrame(function(){a.$elviewer.removeClass("is-resizing-viewport"),a.isActive&&a.vpFocus(a),clearTimeout(i.timerDeflect),i.timerDeflect=setTimeout(function(){r.deflectScrollEvent=!1,n.deflectScrollEvent=!1},throttleViewportChange),a.resizeInProgress=!1})},throttleViewportChange)}):(a.vpSync(),a.ctrlSync()),a.vpSync(),a.ctrlSync()},vpSync:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this.viewPortState,a=o.fixeven?1:0,i=this["viewport-gfx-container"][0],r=this["viewport-html-container"][0],n=i.clientHeight,s=r.clientHeight,l=o.gfx.gapY,c=null,d=null,u=null,h=null,p=null,v=null,f=null,g=null,m=null;this.vpValidate(),(this.isActive||t.force)&&(i.deflectScrollEvent=!0,r.deflectScrollEvent=!0,t.force=!1,(d=this["viewport-gfx-pages"][this.pageIDX])&&(c=d.offsetHeight<n?d.offsetTop+5+Math.floor((d.offsetHeight-n)/2.5)||0:d.offsetTop-l||0),(h=o.html.pageSizes[this.pageIDX-a])&&(u=h.offsetHeight<s?h.offsetTop+Math.floor((h.offsetHeight-s)/2.5)||0:h.offsetTop-l||0),$(i).scrollTop(c),$(r).scrollTop(u),"html"===o.viewMode&&(t.scrollToFirstHL||t.scrollToLastHL)&&(v=$(this["viewport-html-pages"][this.pageIDX]),"1x1"===o.layoutMode?p=v:(f=$(this["viewport-html-pages"][this.pageIDY]),p=t.scrollToFirstHL?v.add(f):f.add(v)),(g=t.scrollToFirstHL?p.find("hlword").first()[0]:p.find("hlword").last()[0])&&((m=g.getBoundingClientRect()).top-r.scrollTop<0||m.bottom-r.scrollTop>r.offsetHeight)&&g.scrollHLIntoView(!1,this["viewport-html-container"].get(0),!1)),this.vpMarkCurPages(),this.vpGfxLoadVisiblePages(),this.resizeInProgress||(clearTimeout(o.timerDeflect),o.timerDeflect=setTimeout(function(){i.deflectScrollEvent=!1,r.deflectScrollEvent=!1},0))),this.hlSync(e,t),this.trbSync(e,t),this.ctrlSync(!!e,!1,t)},vpValidate:function(){var e,t,o,a,i=this.viewPortState;if(!this["viewport-gfx-pages"][0])return!1;(i.gfx.curw=Math.max(this["viewport-gfx-pages"][0].offsetWidth,this["viewport-gfx-pages"][1].offsetWidth,1),i.gfx.realscale=Math.ceil(i.gfx.curw/i.gfx.defw*100),i.gfx.scale=20*Math.ceil(i.gfx.realscale/20),i.gfx.curminh=i.gfx.realscale*i.gfx.minh/100,i.html.valid&&this["viewport-html-pages"])&&(i.html.curw=Math.max(null!==(e=null===(t=this["viewport-html-pages"][0])||void 0===t?void 0:t.offsetWidth)&&void 0!==e?e:0,null!==(o=null===(a=this["viewport-html-pages"][1])||void 0===a?void 0:a.offsetWidth)&&void 0!==o?o:0,1))},vpFocus:function(e){var t=e,o=t.viewPortState;setTimeout(function(){t["viewport-"+o.viewMode+"-container"].focus()},300)}}),jQuery.extend(kViewer.prototype,{vpFindCurPageXY:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.viewPortState,o=t.viewMode,a=t.layoutMode,i=this["viewport-".concat(o,"-container")][0],r=i.scrollHeight,n=i.clientHeight,s=i.scrollTop,l=n/2,c=-1,d=!1,u=-1,h=this.pageIDX,p=this.pageIDY;if(this.isActive){if(l=s<n?.7*n/2*(s/n)+25:s>r-2*n?n/1.6*(1.6-(r-n-s)/n)-25:n/3,this["vp-center"].css({top:l}),"gfx"===o){for(u=0;u<t.gfx.pageSizesChunks.length;u++){var v=t.gfx.pageSizesChunks[u],f=v[v.length-1];if(!(f.offsetTop+f.offsetHeight<s+l)&&(d=t.gfx.pageSizesChunks[u].some(function(e,t){return c=e.rel,e.offsetTop-25<=s+l&&e.offsetTop+e.offsetHeight+25>=s+l})))break}t.fixeven&&"2x1"===a&&1===c&&(c=0)}else if("html"===o){for(u=0;u<t.html.pageSizesChunks.length;u++){var g=t.html.pageSizesChunks[u],m=g[g.length-1];if(!(m.offsetTop+m.offsetHeight<s+l)&&(d=t.html.pageSizesChunks[u].some(function(e){return c=e.rel,e.offsetTop-25<=s+l&&e.offsetTop+e.offsetHeight+25>=s+l})))break}t.fixeven&&("2x1"===a&&1===c&&(c=0),"1x1"===a&&0===c&&(c=1))}d&&(this.pageIDX=c,this.pageIDY=Math.min("2x1"===a?1+c:c,this.pageMAX-1)),!e&&(h!==this.pageIDX||p!==this.pageIDY||!h*p)&&(this.vpMarkCurPages(),this.vpGfxLoadVisiblePages(),this.ctrlSync(!0),this.trbSync(),this.hlSync())}},vpMarkCurPages:function(){var e=this,t=e.viewPortState.viewMode;"gfx"===t&&(e.vpMarkCurGfxPages(),setTimeout(function(){e.vpMarkCurHtmlPages()},throttleDetectCurrent)),"html"===t&&(e.vpMarkCurHtmlPages(),setTimeout(function(){e.vpMarkCurGfxPages()},throttleDetectCurrent))},vpMarkCurGfxPages:function(){var e,t=this;t.viewPortState;requestAnimationFrame(function(){for(t["viewport-gfx-pages"].filter(".is-current").removeClass("is-current"),e=t.pageIDX;e<=t.pageIDY;e++)$(t["viewport-gfx-pages"][e]).addClass("is-current")})},vpMarkCurHtmlPages:function(){var e,t=this,o=t.viewPortState;o.html.loaded&&o.html.valid&&requestAnimationFrame(function(){for(t["viewport-html-pages"].filter(".is-current").removeClass("is-current"),e=t.pageIDX;e<=t.pageIDY;e++)$(t["viewport-html-pages"][e]).addClass("is-current")})}}),jQuery.extend(kViewer.prototype,{vpSetViewMode:function(e){var t=this.viewPortState,o=t.viewMode,a="html"!==e||t.viewModes[e]?e:"gfx";if(this.ctrlHideBoxes(),e===o&&this.isActive)return!1;t.viewMode=a,this.vpResize(!1,!1,{src:"viewport",action:"changeMode",param:e}),this.uacSaveSettings(),"html"!==a||t.html.loaded?"gfx"===a||"html"===a&&t.html.loaded:this.vpHtmlLoadDoc()},vpToggleViewMode:function(e){var t=e.data.self,o=t.viewPortState;if(t.ctrlHideBoxes(e),$(e.currentTarget).hasClass("is-restricted"))return!1;t.vpSetViewMode("gfx"===o.viewMode?"html":"gfx")},vpSetLayoutMode:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=this.viewPortState;this.ctrlHideBoxes(),this._mobile(),!t&&a.layoutMode===e||a.isMobile&&"2x1"===e||!a.layoutModes[e]||this.resizeInProgress||(a.layoutMode=e,this.resizeInProgress=!0,o||this.vpResize(!1,!0,{src:"viewport",action:"changeLayout",param:e}),this.uacSaveSettings())},vpToggleLayoutMode:function(e){var t=e.data.self,o=t.viewPortState.layoutMode;if(t.ctrlHideBoxes(e),$(e.currentTarget).hasClass("is-restricted"))return!1;t.vpSetLayoutMode("2x1"===o?"1x1":"2x1")}}),jQuery.extend(kViewer.prototype,{vpGfxLoadVisiblePages:function(){var e,t,o,a,i,r=$(window),n=this.viewPortState,s=this.highlighterState,l=this["viewport-gfx-container"][0].clientHeight,c=Math.max(0,Math.ceil(l/n.gfx.curminh*("1x1"===n.layoutMode?1:2))),d=c,u=c,h=[];if("gfx"!==n.viewMode)return!1;for(o=this.pageIDX;o<=this.pageIDY;o++)h.push(o);for(o=this.pageIDY+1;o<=this.pageIDY+u+("1x1"===n.layoutMode?1:3);o++)h.push(o);for(o=this.pageIDX-1;o>=this.pageIDX-d-1;o--)h.push(o);for(this["viewport-gfx-pages"].removeClass("is-in-viewport"),o=0;o<h.length;o++)if(!((t=h[o])<0||t>=this.pageMAX||(e=$(this["viewport-gfx-pages"][t])).hasClass("fixeven"))){e.addClass("is-in-viewport");var p=e.data("rel");if(s.valid){var v=s.hldata.pages[p];"hl"!==e.data("hlparsed")&&v&&((a=e.find(".hl--wrapper")).length||(a=$("<span>",{class:"hl--wrapper"}),i=$("<span>",{class:"hl--boxes"}),e.append(a),a.append(i)),v.map(function(e){var t=$("<span>",{class:"hl--box",style:"--l: ".concat(e.boxrel[0],"%; --t: ").concat(e.boxrel[1],"%; --r: ").concat(e.boxrel[2],"%; --b: ").concat(e.boxrel[3],"%")});i.append(t)}),e.data("hlparsed","hl"))}this.ptbCreate(e,p)}r.trigger("tippy:init",["simple"])},vpGfxRotatePage:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"cw",t=this.viewPortState,o=$(this["viewport-gfx-pages"][this.pageIDX]),a=o[0].className.match(/rot-(\d)/),i=a?parseInt(a[1]):0,r="cw"===e?i+1===5?0:i+1:i-1==-1?3:i-1;if(t.isMobile||"1x1"!==t.layoutMode||"gfx"!==t.viewMode||o.hasClass("ls-page")||o.hasClass("ns-page"))return!1;"cw"===e&&(o.removeClass("rot-0 rot-1 rot-2 rot-3 rot-4").addClass("rot-"+r),4===r&&setTimeout(function(){requestAnimationFrame(function(){o.addClass("rot-xxx"),o.removeClass("rot-4"),o.addClass("rot-0"),requestAnimationFrame(function(){o.removeClass("rot-xxx")})})},100)),"ccw"===e&&(3===r?requestAnimationFrame(function(){o.addClass("rot-xxx"),o.removeClass("rot-0"),o.addClass("rot-4"),requestAnimationFrame(function(){o.removeClass("rot-xxx"),o.removeClass("rot-4"),o.addClass("rot-3")})}):o.removeClass("rot-0 rot-1 rot-2 rot-3 rot-4").addClass("rot-"+r))},vpGfxZoom:function(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=this.viewPortState,a=Math.floor(Math.floor(o.zoom.gfx[o.layoutMode].level/stepZoom)*stepZoom),i=this["viewport-gfx-container"].outerWidth(!0),r=this["viewport-gfx-container"].outerHeight(!0),n=o.gfx.curh,s=o.gfx.defh,l=o.gfx.defw;if(!t&&(this.resizeInProgress||!this.isActive||"gfx"!==o.viewMode))return!1;switch(e){case"+":case"=":if(!t&&(this["ctrl-pz-zoom-in"].hasClass("is-disabled")||a+stepZoom>maxZoom[o.layoutMode]))return!1;o.zoom.gfx[o.layoutMode].level=a+stepZoom,o.zoom.gfx[o.layoutMode]._w=100===o.zoom.gfx[o.layoutMode].level,o.zoom.gfx[o.layoutMode]._h=!1;break;case"-":if(!t&&(this["ctrl-pz-zoom-out"].hasClass("is-disabled")||a-stepZoom<minZoom[o.layoutMode]))return!1;o.zoom.gfx[o.layoutMode].level=a-stepZoom,o.zoom.gfx[o.layoutMode]._w=100===o.zoom.gfx[o.layoutMode].level,o.zoom.gfx[o.layoutMode]._h=!1;break;case"*":if(!t&&(this["ctrl-pz-zoom-w"].hasClass("is-disabled")||this["ctrl-pz-zoom-w"].hasClass("is-active")||o.zoom.gfx[o.layoutMode]._w))return!1;o.zoom.gfx[o.layoutMode].level=100,o.zoom.gfx[o.layoutMode]._w=!0,o.zoom.gfx[o.layoutMode]._h=!1;break;case"/":if(!t&&(this["ctrl-pz-zoom-h"].hasClass("is-disabled")||this["ctrl-pz-zoom-h"].hasClass("is-active")||o.zoom.gfx[o.layoutMode]._h))return!1;n=("1x1"===o.layoutMode?i:i/2)*(s/l),o.zoom.gfx[o.layoutMode].level=r/n*100,o.zoom.gfx[o.layoutMode]._w=!1,o.zoom.gfx[o.layoutMode]._h=!0;break;default:if("number"!=typeof e)return!1;o.zoom.gfx[o.layoutMode].level=e,o.zoom.gfx[o.layoutMode]._w=100===o.zoom.gfx[o.layoutMode].level,o.zoom.gfx[o.layoutMode]._h=!1}if(!this.isActive&&!t)return!1;this.vpResize(!1,!0,{src:"viewport-gfx",action:"vpGfxZoom",param:e}),this.uacSaveSettings()}}),jQuery.extend(kViewer.prototype,{vpHtmlInitState:function(){this.viewPortState;this.bmUpdateList()},vpHtmlLoadDoc:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=$(window),a=this,i=a.viewPortState,r=a.highlighterState,n=null!==(e=null==t?void 0:t.query)&&void 0!==e?e:r.query;i.html.fetching||(a.notifierMessageBox("fetching-pubtext"),a.setAppState("loading-viewport"),i.html.fetcher=fetch("//".concat(HOSTS.this,"/").concat(a.settings.root,"/tx/?url=").concat(a.settings.url,"&query=").concat(n)).then(function(e){var t;return i.fetching=!1,null!==(t=e.json())&&void 0!==t?t:new Promise.reject({})}).then(function(e){if(!e.valid)throw new Error("htmler.json.invalid");i.html.valid=!1,i.html.loaded=!0,i.html.pubtext=e.html}).catch(function(e){return a.notifierMessageBox("error"),i.html.valid=!1,i.html.loaded=!0,i.html.pubtext="",Promise.resolve(e)}).then(function(){a["viewport-html-contents"].html(i.html.pubtext),requestAnimationFrame(function(){a["viewport-html-pages"]=a["viewport-html-contents"].find(".page-html"),a["viewport-html-marks"]=a["viewport-html-contents"].find(".hlnav.hl--mark"),a.vpHtmlInitState(),o.trigger("tippy:init",["simple"]),o.trigger("tippy:init:viewer")})}).finally(function(){i.html.fetching=!1,i.htmlLaunch=!0,requestAnimationFrame(function(){a.vpResize(!1,!0,{src:"viewport-html",action:"pubTextLoad"}),a.notifierMessageBox(),a.setAppState("active")})}))},vpHtmlTextSize:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=this.viewPortState,a=parseInt(o.html.textSize);if(o.html.textSize="-"===e&&a-1>=0?a-1:"+"===e&&a+1<=4?a+1:"*"===e?2:a,o.html.textSize===a&&!t)return!1;this.vpResize(!1,!0,{src:"viewport-html",action:"vpHtmlTextSize",param:o.html.textSize}),this.uacSaveSettings()},vpHtmlTextFont:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=this.viewPortState;if(o.html.textFont===e&&!t)return!1;o.html.textFont=e,this.vpResize(!1,!0,{src:"viewport-html",action:"vpHtmlTextFont",param:e}),this.uacSaveSettings()},vpHtmlWidthDoc:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=(!(arguments.length>1&&void 0!==arguments[1])||arguments[1],arguments.length>2&&void 0!==arguments[2]&&arguments[2]),o=this.viewPortState,a=o.zoom.html.level;if((!a||a>100)&&(void 0===o.zoom.html.level&&(o.zoom.html={}),o.zoom.html.level=100,a=100),"2x1"!==o.layoutMode&&!o.isMobile&&(t||!this.resizeInProgress&&this.isActive)){switch(e){case"]":if(!t&&(this["ctrl-pz-textwidth-inc"].hasClass("is-disabled")||a+stepHTMLWidth>maxHTMLWidth))return!1;o.zoom.html.level=a+stepHTMLWidth;break;case"[":if(!t&&(this["ctrl-pz-textwidth-dec"].hasClass("is-disabled")||a-stepHTMLWidth<minHTMLWidth))return!1;o.zoom.html.level=a-stepHTMLWidth;break;default:if("number"!=typeof e)return!1;o.zoom.html.level=e}(this.isActive||t)&&(this.vpResize(!1,!0,{src:"viewport-html",action:"vpHtmlWidthDoc",param:e}),this.uacSaveSettings())}}});